name: Helm Chart CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'helm-charts/**'
      - 'deployments/**'
      - '.github/workflows/helm-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'helm-charts/**'
      - 'deployments/**'

jobs:
  lint-and-test:
    name: Lint and Test Helm Charts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'
      
      - name: Update chart dependencies
        run: |
          cd helm-charts/app-template
          helm dependency update
      
      - name: Lint Helm charts
        run: |
          helm lint helm-charts/app-template
      
      - name: Test template rendering - Basic
        run: |
          helm template test helm-charts/app-template
      
      - name: Test template rendering - With Istio
        run: |
          helm template test helm-charts/app-template \
            --set istio-routing.ingress.path=/test
      
      - name: Test template rendering - With Canary
        run: |
          helm template test helm-charts/app-template \
            --set istio-routing.trafficRouting.enabled=true
      
      - name: Test template rendering - With Kargo (new API)
        run: |
          helm template test helm-charts/app-template \
            --set kargo-config.enabled=true \
            --set kargo-config.project.name=test-project \
            --set kargo-config.warehouse.name=test-warehouse
      
      - name: Test Spring Kotlin App deployment config
        run: |
          helm template spring-kotlin-app helm-charts/app-template \
            -f deployments/spring-kotlin-app/values-spring-kotlin-app.yaml \
            --debug | grep -E "kind: (Rollout|Warehouse|Stage|Project|VirtualService)"
      
      - name: Validate Kargo new API templates
        run: |
          # Test Warehouse template
          helm template test helm-charts/app-template \
            -f deployments/spring-kotlin-app/values-spring-kotlin-app.yaml \
            --show-only charts/kargo-config/templates/warehouse.yaml
          # Test Project template
          helm template test helm-charts/app-template \
            -f deployments/spring-kotlin-app/values-spring-kotlin-app.yaml \
            --show-only charts/kargo-config/templates/project.yaml
          # Test Stages with promotionTemplate
          helm template test helm-charts/app-template \
            -f deployments/spring-kotlin-app/values-spring-kotlin-app.yaml \
            --show-only charts/kargo-config/templates/stages.yaml | grep promotionTemplate
      
      - name: Package charts
        run: |
          mkdir -p helm-charts/packages
          helm package helm-charts/app-template \
            --destination helm-charts/packages
      
      - name: Upload packaged charts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts
          path: helm-charts/packages/*.tgz
          retention-days: 7

  integration-test:
    name: Integration Test with Kind
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'
      
      - name: Set up kind
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: test-cluster
          wait: 60s
      
      - name: Install Argo Rollouts CRDs
        run: |
          kubectl create namespace argo-rollouts || true
          kubectl apply -n argo-rollouts \
            -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml
          kubectl wait --for=condition=Ready pods --all -n argo-rollouts --timeout=300s
      
      - name: Install Istio
        run: |
          curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.24.0 sh -
          cd istio-1.24.0
          bin/istioctl install --set profile=demo -y
          cd ..
          kubectl label namespace default istio-injection=enabled
          kubectl wait --for=condition=Ready pods --all -n istio-system --timeout=300s
      
      - name: Update chart dependencies
        run: |
          cd helm-charts/app-template
          helm dependency update
      
      - name: Deploy test application
        run: |
          helm install test-app helm-charts/app-template \
            --set image.repository=nginx \
            --set image.tag=alpine \
            --set istio-routing.ingress.path=/test \
            --wait --timeout 5m
      
      - name: Run Helm tests
        run: |
          helm test test-app --logs
      
      - name: Check deployed resources
        if: always()
        run: |
          echo "=== Rollouts ==="
          kubectl get rollouts
          echo ""
          echo "=== Services ==="
          kubectl get svc
          echo ""
          echo "=== VirtualServices ==="
          kubectl get virtualservices
          echo ""
          echo "=== Pods ==="
          kubectl get pods -A
      
      - name: Cleanup
        if: always()
        run: |
          helm delete test-app || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'helm-charts/'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
